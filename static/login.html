<script src="https://apis.google.com/js/api.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<script>

    const NAMESPACE_ANVIL_DATA_STORAGE = "anvil-datastorage";
    const URL_WORKSPACES = "https://api.firecloud.org/api/workspaces";
    
    var googleClientId = "511630731578-s5oh1mqqbsan3ja0rcl0iu447lmt0bac.apps.googleusercontent.com";

    var isAuthorized;
    var currentApiRequest;
    var token;

    /**
     * Execute fetch of data and corresponding callback on receipt of response.
     */
    function fetch(url, callback) {

        return new Promise((resolve, reject) => {

            const http = new XMLHttpRequest();
            http.addEventListener("load", () => {
                if ( http.status >= 200 && http.status < 300 ) {
                    const data = JSON.parse(http.responseText);
                    resolve(callback(data));
                    return;
                }
                reject({ status: http.status, text: http.statusText })
            });
            http.open("GET", url);
            http.setRequestHeader("authorization", `Bearer ${token}`);
            http.send();
        });
    }

    /**
     * Fetch the sample and participant counts for the set of specified workspaces. Resolves hash of
     * {workspaceName, participantCount, sampleCount}.
     */
    function fetchWorkspaceCounts(workspaceNames) {
        
        // test code - to run only two workspaces, uncomment below
        // workspaceNames = ["AnVIL_CCDG_WashU_CVD_EOCAD_BioMe_WGS", "ANVIL_CMG_Broad_Muscle_Laing_WES"];

        const promises = [];
        workspaceNames.forEach(workspaceName => {

            const callback = (data) => {
                return {
                    workspaceName,
                    discoveryCount: data.discovery?.count || 0,
                    familyCount: data.family?.count || 0,
                    participantCount: data.participant?.count || 0,
                    sampleCount: data.sample?.count || 0,
                    subjectCount: data.subject?.count || 0,
                };
            };
            const url = `${URL_WORKSPACES}/${NAMESPACE_ANVIL_DATA_STORAGE}/${workspaceName}/entities`;
            promises.push(fetch(url, callback));
        });

        return Promise.all(promises);
    }

    /**
     * Fetch set of workspace names in the anvil_datastorage namespace. Resolves array of workspace names.
     * 
     */
    function fetchWorkspaces() {
        
        const callback = (data) => {
            return data
                .filter(workspaceConfig => {
                    return workspaceConfig.workspace.namespace === NAMESPACE_ANVIL_DATA_STORAGE;
                })
                .map((workspaceConfig) => {
                    return workspaceConfig.workspace.name;
                });
        };
        
        return fetch(URL_WORKSPACES, callback);
    }

    function sendAuthorizedApiRequest(requestDetails) {
        currentApiRequest = requestDetails;
        if (isAuthorized) {
            // Make API request
            // gapi.client.request(requestDetails)

            // Reset currentApiRequest variable.
            currentApiRequest = {};
        } else {
            GoogleAuth.signIn();
        }
    }

    function set_content(isSignedIn) {
        if (isSignedIn) {
            document.getElementById("loginstatus").innerHTML = `<a href="#" onclick="signOut();">Sign out</a>`;
            if (token != null) {
                fetchWorkspaces()
                    .then(fetchWorkspaceCounts)
                    .then((workspaceCounts) => {
                        const csvRows =
                            ["<div>Workspace,Discovery Count,Family Count,Participant Count,Sample Count,Subject Count</div>"];
                        workspaceCounts.forEach(workspaceCount => {
                            const csvRow = [
                                workspaceCount.workspaceName,
                                workspaceCount.discoveryCount,
                                workspaceCount.familyCount,
                                workspaceCount.participantCount,
                                workspaceCount.sampleCount,
                                workspaceCount.subjectCount
                            ];
                            csvRows.push(`<div>${csvRow.join(",")}</div>`);
                            
                        });
                        const workspacesEl = document.getElementById("workspaces");
                        workspacesEl.innerHTML += csvRows.join("");
                    })
                    .catch(console.error);
            }
        } else {
            document.getElementById("loginstatus").innerHTML = "";
            document.getElementById("workspaces").innerHTML = "";
        }
    }

    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            isAuthorized = true;
            if (currentApiRequest) {
                sendAuthorizedApiRequest(currentApiRequest);
            }
        } else {
            isAuthorized = false;
        }
        set_content(isSignedIn);
    }

    (async function () {
        await new Promise(resolve => gapi.load('auth2', resolve));
        gapi.auth2.init({
            clientId: googleClientId
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            // Listen for sign-in state changes.
            GoogleAuth.isSignedIn.listen(updateSigninStatus);
            user = GoogleAuth.currentUser.get();
            authResponse = user.getAuthResponse(true);
            token = authResponse != null ? authResponse.access_token : null;
            set_content(user.isSignedIn());
            if(! user.isSignedIn()){
                GoogleAuth.signIn();
            }
        });
    })();

    function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
            console.log('User signed out.');
        });
    }

</script>

<html lang="en">
<body>
Hello Terra World
</body>
<div className="g-signin2" data-onsuccess="onSignIn"></div>
<div id="loginstatus"></div>
<div id="workspaces"></div>
</html>
